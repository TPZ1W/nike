<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin.html}">
<head>
    <title>Dashboard</title>
</head>

<body>
<section layout:fragment="content">
    <div class="content-header">
        <h1>Dashboard</h1>
    </div>

    <section class="content">
        <div class="row">
            <!-- Tổng doanh thu -->
            <div class="col-lg-3 col-xs-6">
                <div class="small-box bg-green">
                    <div class="inner">
                        <h3 id="totalRevenue">₫0</h3>
                        <p>Tổng Doanh Thu</p>
                    </div>
                    <div class="icon">
                        <i class="fa fa-money"></i>
                    </div>
                </div>
            </div>

            <!-- Tổng sản phẩm -->
            <div class="col-lg-3 col-xs-6">
                <div class="small-box bg-blue">
                    <div class="inner">
                        <h3 id="totalProducts">0</h3>
                        <p>Tổng Sản Phẩm</p>
                    </div>
                    <div class="icon">
                        <i class="fa fa-cubes"></i>
                    </div>
                </div>
            </div>

            <!-- Đơn hàng đã hoàn thành -->
            <div class="col-lg-3 col-xs-6">
                <div class="small-box bg-yellow">
                    <div class="inner">
                        <h3 id="totalOrders">0</h3>
                        <p>Đơn Đã Hoàn Thành</p>
                    </div>
                    <div class="icon">
                        <i class="fa fa-shopping-cart"></i>
                    </div>
                </div>
            </div>

            <!-- Tổng người dùng -->
            <div class="col-lg-3 col-xs-6">
                <div class="small-box bg-red">
                    <div class="inner">
                        <h3 id="totalUsers">0</h3>
                        <p>Tổng Người Dùng</p>
                    </div>
                    <div class="icon">
                        <i class="fa fa-users"></i>
                    </div>
                </div>
            </div>
        </div>

            <!-- Trạng thái đơn hàng -->
            <div class="col-md-6">
                <div class="box box-solid bg-white">
                    <div class="box-header with-border">
                        <i class="fa fa-list"></i>
                        <h3 class="box-title text-black">Trạng Thái Đơn Hàng</h3>
                    </div>
                    <div class="box-body">
                        <table class="table table-bordered text-center">
                            <thead>
                            <tr>
                                <th>Trạng thái</th>
                                <th>Số lượng</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>Chờ xử lý</td>
                                <td><span id="pendingCount">0</span></td>
                            </tr>
                            <tr>
                                <td>Đang xử lý</td>
                                <td><span id="processingCount">0</span></td>
                            </tr>
                            <tr>
                                <td>Đang giao</td>
                                <td><span id="shippingCount">0</span></td>
                            </tr>
                            <tr>
                                <td>Đã giao</td>
                                <td><span id="deliveredCount">0</span></td>
                            </tr>
                            <tr>
                                <td>Đã hủy</td>
                                <td><span id="cancelledCount">0</span></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Top sản phẩm bán chạy -->
            <div class="col-md-6">
                <div class="box box-solid bg-white">
                    <div class="box-header with-border">
                        <i class="fa fa-fire"></i>
                        <h3 class="box-title text-black">Top Sản Phẩm Bán Chạy</h3>
                    </div>
                    <div class="box-body">
                        <table class="table table-bordered text-center">
                            <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Đã bán</th>
                            </tr>
                            </thead>
                            <tbody id="topProducts">
                            <tr><td colspan="2">Đang tải...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</section>

<!-- Scripts -->
<th:block layout:fragment="scripts">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Dashboard JavaScript loaded");

            // Fetch thống kê tổng
            fetch("/api/admin/dashboard/statistics")
                .then(res => res.json())
                .then(data => {
                    document.getElementById("totalRevenue").textContent = `₫${data.totalRevenue.toLocaleString()}`;
                    document.getElementById("totalProducts").textContent = data.totalProducts;
                    document.getElementById("totalOrders").textContent = data.totalOrders;
                    document.getElementById("totalUsers").textContent = data.totalUsers;
                })
                .catch(err => console.error("Lỗi tải thống kê:", err));

            // Fetch trạng thái đơn hàng
            fetch("/api/admin/dashboard/order-status")
                .then(res => res.json())
                .then(data => {
                    console.log("Order status data:", data);
                    document.getElementById("deliveredCount").textContent = data.delivered || 0;
                    document.getElementById("shippingCount").textContent = data.shipping || 0;
                    document.getElementById("processingCount").textContent = data.processing || 0;
                    document.getElementById("pendingCount").textContent = data.pending || 0;
                    document.getElementById("cancelledCount").textContent = data.cancelled || 0;
                })
                .catch(err => console.error("Lỗi tải trạng thái đơn:", err));

            // Fetch top sản phẩm
            fetch("/api/admin/dashboard/top-products")
                .then(res => res.json())
                .then(products => {
                    console.log("Top products data:", products);
                    const tbody = document.getElementById("topProducts");
                    tbody.innerHTML = "";
                    
                    if (products && products.length > 0) {
                        products.forEach(p => {
                            const row = `<tr><td>${p.name || p.productName}</td><td>${p.sold || p.soldQuantity || 0}</td></tr>`;
                            tbody.insertAdjacentHTML("beforeend", row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="2">Không có dữ liệu</td></tr>';
                    }
                })
                .catch(err => {
                    console.error("Lỗi tải top sản phẩm:", err);
                    document.getElementById("topProducts").innerHTML = '<tr><td colspan="2">Lỗi tải dữ liệu</td></tr>';
                });
        });
    </script>
</th:block>
</body>
</html>