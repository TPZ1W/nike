<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin}">

<th:block layout:fragment="page_head">
    <title>Qu·∫£n l√Ω m√£ gi·∫£m gi√° | Admin</title>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-modern {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-modern table {
            width: 100%;
            margin: 0;
        }
        .table-modern th {
            background: #f8f9fa;
            padding: 15px;
            font-weight: 600;
        }
        .table-modern td {
            padding: 15px;
            border-top: 1px solid #dee2e6;
        }
        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        .badge-success {
            background: #28a745;
            color: white;
        }
        .badge-danger {
            background: #dc3545;
            color: white;
        }
        .badge-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-action {
            border: none;
            background: none;
            padding: 8px;
            margin: 0 2px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-action:hover {
            background: #f8f9fa;
        }
    </style>
</th:block>

<body>
<th:block layout:fragment="content">
    <div style="padding: 20px;">
        <h1>üé´ Qu·∫£n l√Ω m√£ gi·∫£m gi√°</h1>
        <p>T·∫°o, ch·ªânh s·ª≠a v√† qu·∫£n l√Ω c√°c m√£ gi·∫£m gi√° cho c·ª≠a h√†ng</p>
        
        <div style="margin: 20px 0;">
            <a href="/admin/coupons/create" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                ‚ûï T·∫°o m√£ gi·∫£m gi√° m·ªõi
            </a>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üìä T·ªïng s·ªë m√£</h3>
                <p style="font-size: 24px; font-weight: bold; color: #007bff;" th:text="${totalCoupons ?: 0}">0</p>
            </div>
            <div class="stat-card">
                <h3>‚úÖ ƒêang ho·∫°t ƒë·ªông</h3>
                <p style="font-size: 24px; font-weight: bold; color: #28a745;" th:text="${activeCoupons ?: 0}">0</p>
            </div>
            <div class="stat-card">
                <h3>‚è∞ C√≤n hi·ªáu l·ª±c</h3>
                <p style="font-size: 24px; font-weight: bold; color: #ffc107;" th:text="${validCoupons ?: 0}">0</p>
            </div>
            <div class="stat-card">
                <h3>üìà T·ª∑ l·ªá hi·ªáu l·ª±c</h3>
                <p style="font-size: 24px; font-weight: bold; color: #dc3545;">
                    <span th:text="${#numbers.formatDecimal((validCoupons ?: 0) * 100.0 / (totalCoupons ?: 1), 1, 1)}">0</span>%
                </p>
            </div>
        </div>

        <!-- Search -->
        <div style="margin: 20px 0;">
            <form th:action="@{/admin/coupons}" method="get" style="display: flex; gap: 10px;">
                <input type="text" name="search" th:value="${search}" 
                       placeholder="T√¨m ki·∫øm m√£ gi·∫£m gi√°..." 
                       style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; flex: 1;">
                <button type="submit" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px;">
                    üîç T√¨m ki·∫øm
                </button>
                <a th:if="${search}" href="/admin/coupons" style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;">
                    ‚ùå X√≥a b·ªô l·ªçc
                </a>
            </form>
        </div>

        <!-- Table -->
        <div class="table-modern">
            <table>
                <thead>
                    <tr>
                        <th>M√£ gi·∫£m gi√°</th>
                        <th>T√™n</th>
                        <th>Lo·∫°i</th>
                        <th>Gi√° tr·ªã</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>L∆∞·ª£t s·ª≠ d·ª•ng</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${coupons.empty}">
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            üì≠ Kh√¥ng c√≥ m√£ gi·∫£m gi√° n√†o
                            <br><br>
                            <a href="/admin/coupons/create" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                                T·∫°o m√£ gi·∫£m gi√° ƒë·∫ßu ti√™n
                            </a>
                        </td>
                    </tr>
                    
                    <tr th:each="coupon : ${coupons.content}" th:unless="${coupons.empty}">
                        <td>
                            <strong th:text="${coupon.code}">CODE</strong>
                        </td>
                        <td th:text="${coupon.name}">T√™n m√£ gi·∫£m gi√°</td>
                        <td>
                            <span th:if="${coupon.discountType.name() == 'PERCENTAGE'}" class="badge badge-secondary">
                                % Ph·∫ßn trƒÉm
                            </span>
                            <span th:if="${coupon.discountType.name() == 'FIXED_AMOUNT'}" class="badge badge-secondary">
                                üí∞ S·ªë ti·ªÅn
                            </span>
                        </td>
                        <td>
                            <span th:if="${coupon.discountType.name() == 'PERCENTAGE'}" 
                                  th:text="${coupon.discountValue + '%'}">10%</span>
                            <span th:if="${coupon.discountType.name() == 'FIXED_AMOUNT'}" 
                                  th:text="${#numbers.formatDecimal(coupon.discountValue, 0, 0) + '‚Ç´'}">50,000‚Ç´</span>
                        </td>
                        <td>
                            <span th:if="${coupon.isActive}" class="badge badge-success">
                                ‚úÖ Ho·∫°t ƒë·ªông
                            </span>
                            <span th:unless="${coupon.isActive}" class="badge badge-danger">
                                ‚ùå T·∫°m d·ª´ng
                            </span>
                        </td>
                        <td>
                            <span th:text="${coupon.usedCount ?: 0}">0</span>
                            <span th:if="${coupon.usageLimit != null}" 
                                  th:text="'/' + ${coupon.usageLimit}"> / 100</span>
                            <span th:if="${coupon.usageLimit == null}"> / ‚àû</span>
                        </td>
                        <td>
                            <button type="button" class="btn-action" title="Ch·ªânh s·ª≠a"
                                    th:onclick="'editCoupon(' + ${coupon.id} + ')'">
                                ‚úèÔ∏è
                            </button>
                            <button type="button" class="btn-action" title="B·∫≠t/T·∫Øt"
                                    th:onclick="'toggleCoupon(' + ${coupon.id} + ', ' + ${coupon.isActive} + ')'">
                                <span th:if="${coupon.isActive}">‚è∏Ô∏è</span>
                                <span th:unless="${coupon.isActive}">‚ñ∂Ô∏è</span>
                            </button>
                            <button type="button" class="btn-action" title="X√≥a"
                                    th:onclick="'deleteCoupon(' + ${coupon.id} + ', \'' + ${coupon.code} + '\')'">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div th:if="${coupons.totalPages > 1}" style="margin-top: 20px; text-align: center;">
            <div style="display: inline-flex; gap: 5px;">
                <a th:if="${!coupons.first}" 
                   th:href="@{/admin/coupons(page=${coupons.number - 1}, search=${search})}"
                   style="padding: 8px 12px; background: #f8f9fa; text-decoration: none; border-radius: 4px;">
                    ‚¨ÖÔ∏è Tr∆∞·ªõc
                </a>
                
                <span th:each="page : ${#numbers.sequence(0, coupons.totalPages - 1)}" 
                      th:if="${page >= coupons.number - 2 && page <= coupons.number + 2}">
                    <a th:if="${page != coupons.number}"
                       th:href="@{/admin/coupons(page=${page}, search=${search})}"
                       th:text="${page + 1}"
                       style="padding: 8px 12px; background: #f8f9fa; text-decoration: none; border-radius: 4px; margin: 0 2px;">1</a>
                    <span th:if="${page == coupons.number}"
                          th:text="${page + 1}"
                          style="padding: 8px 12px; background: #007bff; color: white; border-radius: 4px; margin: 0 2px;">1</span>
                </span>
                
                <a th:if="${!coupons.last}" 
                   th:href="@{/admin/coupons(page=${coupons.number + 1}, search=${search})}"
                   style="padding: 8px 12px; background: #f8f9fa; text-decoration: none; border-radius: 4px;">
                    Sau ‚û°Ô∏è
                </a>
            </div>
        </div>
    </div>

    <script>
        function editCoupon(id) {
            window.location.href = '/admin/coupons/' + id + '/edit';
        }
        
        function toggleCoupon(id, currentStatus) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën thay ƒë·ªïi tr·∫°ng th√°i m√£ gi·∫£m gi√° n√†y?')) {
                fetch('/admin/coupons/' + id + '/toggle-status', {
                    method: 'POST'
                }).then(() => {
                    location.reload();
                }).catch(err => {
                    alert('C√≥ l·ªói x·∫£y ra: ' + err);
                });
            }
        }
        
        function deleteCoupon(id, code) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√£ gi·∫£m gi√° "' + code + '"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                fetch('/admin/coupons/' + id + '/delete', {
                    method: 'POST'
                }).then(() => {
                    location.reload();
                }).catch(err => {
                    alert('C√≥ l·ªói x·∫£y ra: ' + err);
                });
            }
        }
        
        // Show success messages
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === 'created') {
            alert('‚úÖ T·∫°o m√£ gi·∫£m gi√° th√†nh c√¥ng!');
        } else if (urlParams.get('success') === 'updated') {
            alert('‚úÖ C·∫≠p nh·∫≠t m√£ gi·∫£m gi√° th√†nh c√¥ng!');
        } else if (urlParams.get('success') === 'deleted') {
            alert('‚úÖ X√≥a m√£ gi·∫£m gi√° th√†nh c√¥ng!');
        }
    </script>
</th:block>

</body>
</html>