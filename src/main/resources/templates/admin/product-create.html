<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin}">

<th:block layout:fragment="page_head">
    <title>Thêm sản phẩm mới</title>
</th:block>

<body>
<th:block layout:fragment="content">
    <section class="content-header">
        <h1><i class="fa fa-plus-circle text-primary"></i> Thêm sản phẩm mới</h1>
        <a th:href="@{/admin/products}" class="btn btn-default">
            <i class="fa fa-arrow-left"></i> Quay lại
        </a>
    </section>

    <section class="content">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Thông tin sản phẩm</h3>
            </div>

            <!-- Form -->
            <form role="form" th:action="@{/admin/products/save}" method="post" enctype="multipart/form-data" id="createForm">
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Tên sản phẩm</label>
                                <input type="text" class="form-control" name="name" placeholder="Nhập tên sản phẩm..." required>
                            </div>

                            <div class="form-group">
                                <label>Slug (URL)</label>
                                <input type="text" class="form-control" name="slug" placeholder="Ví dụ: nike-air-max-97">
                            </div>

                            <div class="form-group">
                                <label>Phụ đề</label>
                                <input type="text" class="form-control" name="subTitle" placeholder="Ví dụ: Phiên bản giới hạn 2025">
                            </div>

                            <div class="form-group">
                                <label>Mô tả chi tiết</label>
                                <textarea class="form-control" name="description" rows="5" placeholder="Nhập mô tả sản phẩm..."></textarea>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Giá (VNĐ)</label>
                                <input type="number" class="form-control" name="price" min="0" step="1000" required>
                            </div>
                            <div class="form-group">
                                <label>Số lượng tồn kho</label>
                                <input type="number" class="form-control" name="stock" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Danh mục</label>
                                <select class="form-control" name="categoryId" required>
                                    <option value="" disabled selected>-- Chọn danh mục --</option>
                                    <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Ảnh sản phẩm</label>
                                <input type="file" id="imageInput" name="images" multiple accept="image/*">
                                <p class="help-block">Bạn có thể chọn nhiều ảnh.</p>
                                <div id="preview" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="box-footer text-right">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save"></i> Lưu sản phẩm
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- JS xử lý ảnh -->
    <script>
        const input = document.getElementById('imageInput');
        const preview = document.getElementById('preview');
        const form = document.getElementById('createForm');

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        input.addEventListener('change', () => {
            preview.innerHTML = '';
            [...input.files].forEach(file => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.style.border = '1px solid #ccc';
                img.style.borderRadius = '5px';
                preview.appendChild(img);
            });
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const files = [...input.files];
            let base64Images = [];

            try {
                base64Images = await Promise.all(files.map(fileToBase64));
            } catch (err) {
                alert("❌ Lỗi đọc ảnh!");
                return;
            }

            const payload = {
                name: form.name.value.trim(),
                slug: form.slug.value.trim(),
                subTitle: form.subTitle.value.trim(),
                description: form.description.value.trim(),
                stock: parseInt(form.stock.value),
                price: parseFloat(form.price.value),
                categoryId: parseInt(form.categoryId.value),
                images: base64Images
            };

            try {
                const res = await fetch("/api/v1/products", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("HTTP " + res.status);
                const data = await res.json();
                alert("✅ Thêm sản phẩm thành công: " + data.name);
                window.location.href = "/admin/products";
            } catch (err) {
                console.error(err);
                alert("❌ Thêm sản phẩm thất bại!");
            }
        });
    </script>
</th:block>
</body>
</html>
