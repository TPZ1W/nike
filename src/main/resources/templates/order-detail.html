<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/client}">

<th:block layout:fragment="page_head">
    <title>Chi ti·∫øt ƒë∆°n h√†ng</title>
    <style>
        .order-container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .order-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .status-badge {
            padding: 6px 10px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #cce5ff;
            color: #004085;
        }

        .status-shipping {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-canceled {
            background: #f8d7da;
            color: #721c24;
        }

        .product-row {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f1f1f1;
            padding: 12px 0;
        }

        .product-row img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 15px;
        }

        .product-info {
            flex: 1;
        }

        .product-price {
            text-align: right;
            font-weight: 500;
        }

        .order-summary {
            margin-top: 20px;
            text-align: right;
        }

        .order-summary strong {
            font-size: 1.1rem;
        }

        .btn-cancel {
            margin-top: 20px;
        }

        .rating {
            direction: rtl;
            display: inline-flex;
            font-size: 24px;
        }

        .rating input {
            display: none;
        }

        .rating label {
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s;
        }

        .rating input:checked ~ label,
        .rating label:hover,
        .rating label:hover ~ label {
            color: #f1c40f;
        }

        .review-box {
            background-color: #fafafa;
        }

        .image-preview img {
            transition: transform 0.2s;
        }

        .image-preview img:hover {
            transform: scale(1.05);
        }
        .product-row:hover .product-info-row {
            text-decoration: underline;
        }
    </style>
</th:block>

<body>
<th:block layout:fragment="content">
    <section class="order-container">
        <div class="order-header">
            <h3>ƒê∆°n h√†ng #<span th:text="${order.id}">1001</span></h3>
            <p>
                Ng√†y ƒë·∫∑t: <strong th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></strong><br>
                Tr·∫°ng th√°i:
                <span th:switch="${order.status.toLowerCase()}">
                            <span th:case="'pending'">üü° ƒêang ch·ªù x√°c nh·∫≠n</span>
                            <span th:case="'confirmed'">üîµ ƒê√£ x√°c nh·∫≠n</span>
                            <span th:case="'waiting_for_payment'">üí≥ ƒêang ch·ªù thanh to√°n</span>
                            <span th:case="'shipping'">üöö ƒêang giao h√†ng</span>
                            <span th:case="'completed'">‚úÖ ƒê√£ ho√†n th√†nh</span>
                            <span th:case="'paid'">‚úÖ Thanh to√°n VNPAY th√†nh c√¥ng</span>
                            <span th:case="'fail'"> ‚ùå Thanh to√°n th·∫•t b·∫°i</span>
                            <span th:case="'canceled'">
                                ‚ùå ƒê√£ h·ªßy
                                <span th:if="${order.paymentMethod == 'VNPAY'}" class="text-danger d-block mt-1">
                                    Vui l√≤ng li√™n h·ªá nh√¢n vi√™n qua <strong>chatbot</strong> ƒë·ªÉ ƒë∆∞·ª£c ho√†n ti·ªÅn.
                                </span>
                            </span>
                            <span th:case="*">-</span> <!-- fallback n·∫øu kh√¥ng kh·ªõp -->
                        </span>
            </p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h5>Th√¥ng tin giao h√†ng</h5>
                <p>
                    <strong>Ng∆∞·ªùi nh·∫≠n:</strong> <span th:text="${order.user.fullName}">Nguy·ªÖn VƒÉn A</span><br>
                    <strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span th:text="${order.phone}">0909123456</span><br>
                    <strong>ƒê·ªãa ch·ªâ:</strong> <span th:text="${order.shippingAddress}">123 Nguy·ªÖn Tr√£i, TP.HCM</span>
                </p>
            </div>
            <div class="col-md-6">
                <h5>Thanh to√°n</h5>
                <p>
                    <strong>Ph∆∞∆°ng th·ª©c:</strong> <span th:text="${order.paymentMethod}">VNPAY</span><br>
                    <strong>T·ªïng ti·ªÅn:</strong>
                    <span th:text="${#numbers.formatDecimal(order.finalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"
                          class="text-danger font-weight-bold">1.500.000 ‚Ç´</span><br>
                    <strong>M√£ gi·∫£m gi√°:</strong>
                    <span th:text="${order.coupon != null ? order.coupon.code : '-'}">-</span>
                </p>
            </div>
        </div>

        <hr>

        <h5>S·∫£n ph·∫©m trong ƒë∆°n</h5>
        <div th:each="item : ${order.items}" class="product-row"
             th:onclick="window.location.href='/products/' + [[${item.product.id}]]" style="cursor: pointer">
            <!-- ‚úÖ Hi·ªÉn th·ªã ·∫£nh ƒë·∫ßu ti√™n -->
            <div>
                <img th:src="${#lists.isEmpty(item.product.images)} ?
                              @{/img/no-image.png} :
                              @{${item.product.images[0]}}"
                     alt="Product">
            </div>
            <div class="product-info">
                <div class="product-info-row"><strong th:text="${item.product.name}">√Åo Nike Air</strong></div>
                <small>S·ªë l∆∞·ª£ng: <span th:text="${item.quantity}">1</span></small><br>
                <div class="d-flex flex-wrap mt-1">
                    <div th:each="img : ${item.product.images}" class="mr-1">
                        <img th:src="@{${img}}" style="width:40px;height:40px;border-radius:5px;">
                    </div>
                </div>
            </div>
            <div class="product-price">
                <span th:text="${#numbers.formatDecimal(item.productPrice, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">1.000.000 ‚Ç´</span><br>
                <small class="text-muted">T·ªïng:
                    <span th:text="${#numbers.formatDecimal(item.productPrice * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                </small>
            </div>
        </div>

        <div class="order-summary">
            <del th:if="${order.totalDiscount > 0}" class="text-dark">
                <strong>T·ªïng c·ªông:</strong>
                <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"
                      class="text-dark">1.500.000 ‚Ç´</span>
            </del>
            <p>
                <strong>T·ªïng c·ªông:</strong>
                <span th:text="${#numbers.formatDecimal(order.finalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"
                      class="text-danger">1.500.000 ‚Ç´</span>
            </p>

            <div th:if="${order.status.toLowerCase() == 'pending'
           || order.status.toLowerCase() == 'confirmed'
           || order.status.toLowerCase() == 'paid'}">
                <button type="button"
                        class="btn btn-danger btn-cancel"
                        th:data-order-id="${order.id}">
                    <i class="fa fa-times"></i> H·ªßy ƒë∆°n h√†ng
                </button>
            </div>
        </div>

        <div class="text-center mt-4">
            <a href="/orders/history" class="btn btn-outline-secondary">
                ‚Üê Quay l·∫°i danh s√°ch
            </a>
        </div>

        <div th:if="${order.status.toLowerCase() == 'completed'}" class="mt-5">
            <h5>ƒê√°nh gi√° s·∫£n ph·∫©m</h5>

            <div th:each="item : ${order.items}" class="review-box border rounded p-3 my-3">
                <div class="d-flex align-items-center mb-2">
                    <img th:src="${#lists.isEmpty(item.product.images)} ? @{/img/no-image.png} : @{${item.product.images[0]}}"
                         alt="Product" style="width:60px; height:60px; border-radius:5px; margin-right:15px;">
                    <div>
                        <strong th:text="${item.product.name}">T√™n s·∫£n ph·∫©m</strong>
                    </div>
                </div>

                <div th:if="${item.reviewed}" class="mt-3 border rounded bg-light p-3">
                    <p class="text-success mb-2">
                        <i class="fa fa-check-circle"></i> B·∫°n ƒë√£ ƒë√°nh gi√° s·∫£n ph·∫©m n√†y
                    </p>

                    <div class="rating mb-2" style="color: #ffc107;">
                        <!-- L·∫∑p sao v√†ng theo rating -->
                        <i class="fa fa-star" th:each="star : ${#numbers.sequence(1, item.review.rating)}"></i>
                        <!-- N·∫øu mu·ªën hi·ªán sao tr·ªëng -->
                        <i class="fa fa-star-o text-muted" th:each="star : ${#numbers.sequence(item.review.rating + 1, 5)}"></i>
                    </div>

                    <h6 th:text="${item.review.title}" class="fw-bold" th:if="${item.review.title != null and !#strings.isEmpty(item.review.title)}"></h6>
                    <p th:text="${item.review.comment}" class="mb-2"></p>

                    <!-- ·∫¢nh review -->
                    <div th:if="${item.review.images != null and !#lists.isEmpty(item.review.images)}"
                         class="d-flex flex-wrap mt-2">
                        <img th:each="img : ${item.review.images}"
                             th:src="${img}"
                             alt="·∫¢nh ƒë√°nh gi√°"
                             style="width:80px; height:80px; object-fit:cover; border-radius:6px; margin-right:5px; margin-bottom:5px;">
                    </div>
                </div>

                <!-- ‚≠ê Form ƒë√°nh gi√° -->
                <form th:id="'review-form-' + ${item.product.id}" th:if="${!item.reviewed}"
                      th:onsubmit="'submitReview(event, ' + ${item.product.id} + ')'"
                      enctype="multipart/form-data">

                    <div class="form-group">
                        <label>ƒê√°nh gi√°:</label>
                        <div class="rating">
                            <input type="radio" th:name="'rating-' + ${item.product.id}" value="5"
                                   th:id="'star5-' + ${item.product.id}">
                            <label th:for="'star5-' + ${item.product.id}">‚òÖ</label>

                            <input type="radio" th:name="'rating-' + ${item.product.id}" value="4"
                                   th:id="'star4-' + ${item.product.id}">
                            <label th:for="'star4-' + ${item.product.id}">‚òÖ</label>

                            <input type="radio" th:name="'rating-' + ${item.product.id}" value="3"
                                   th:id="'star3-' + ${item.product.id}">
                            <label th:for="'star3-' + ${item.product.id}">‚òÖ</label>

                            <input type="radio" th:name="'rating-' + ${item.product.id}" value="2"
                                   th:id="'star2-' + ${item.product.id}">
                            <label th:for="'star2-' + ${item.product.id}">‚òÖ</label>

                            <input type="radio" th:name="'rating-' + ${item.product.id}" value="1"
                                   th:id="'star1-' + ${item.product.id}">
                            <label th:for="'star1-' + ${item.product.id}">‚òÖ</label>
                        </div>
                    </div>

                    <div class="form-group mt-2">
                        <input type="text" name="title" class="form-control" placeholder="Ti√™u ƒë·ªÅ (t√πy ch·ªçn)">
                    </div>

                    <div class="form-group mt-2">
                <textarea name="comment" class="form-control" rows="3"
                          placeholder="Chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n..."></textarea>
                    </div>

                    <!-- üñºÔ∏è Upload ·∫£nh -->
                    <div class="form-group mt-3">
                        <label th:for="'images-' + ${item.product.id}">H√¨nh ·∫£nh (t·ªëi ƒëa 5):</label>
                        <input type="file"
                               th:id="'images-' + ${item.product.id}"
                               name="images"
                               class="form-control-file"
                               multiple accept="image/*"
                               th:onchange="'previewImages(event, ' + ${item.product.id} + ')'">
                        <div class="image-preview d-flex mt-2"
                             th:id="'preview-' + ${item.product.id}"></div>
                    </div>

                    <div class="text-right mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-paper-plane"></i> G·ª≠i ƒë√°nh gi√°
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script th:inline="javascript">
            $(document).ready(function () {
                // Khi nh·∫•n n√∫t "H·ªßy ƒë∆°n h√†ng"
                $(".btn-cancel").on("click", function () {
                    const orderId = $(this).data("order-id");
                    console.log(orderId)
                    const btn = $(this);

                    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y kh√¥ng?")) {
                        return;
                    }

                    $.ajax({
                        url: `/orders/${orderId}/cancel`,
                        type: "POST",
                        contentType: "application/json",
                        headers: {},
                        success: function (result) {
                            if (result.success) {
                                alert(result.message || "ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!");
                                window.location.reload();
                            } else {
                                alert("L·ªói: " + (result.message || "Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng"));
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("L·ªói khi g·ªçi API h·ªßy ƒë∆°n:", error);
                            alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i sau.");
                        }
                    });
                });
            });
        </script>

        <script>
            function submitReview(event, productId) {
                event.preventDefault(); // Kh√¥ng reload trang

                const form = document.getElementById("review-form-" + productId);
                const formData = new FormData(form); // L·∫•y d·ªØ li·ªáu (bao g·ªìm ·∫£nh)
                const rating = form.querySelector(`input[name="rating-${productId}"]:checked`);
                if (rating) {
                    formData.append("rating", rating.value);
                } else {
                    alert("Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°!");
                    return;
                }

                // G·ªçi API AJAX
                $.ajax({
                    url: `/reviews/add/${productId}`,
                    type: "POST",
                    data: formData,
                    processData: false, // b·∫Øt bu·ªôc khi g·ª≠i FormData
                    contentType: false, // b·∫Øt bu·ªôc khi g·ª≠i FormData
                    headers: {
                        "X-CSRF-TOKEN": $("meta[name='_csrf']").attr("content")
                    },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            form.reset();
                            $("#preview-" + productId).empty(); // clear preview ·∫£nh
                        } else {
                            alert("L·ªói: " + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("L·ªói khi g·ª≠i ƒë√°nh gi√°:", error);
                        alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.");
                    }
                });
            }

            function previewImages(event, productId) {
                const files = event.target.files;
                const previewContainer = document.getElementById("preview-" + productId);
                previewContainer.innerHTML = "";

                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        img.style.width = "80px";
                        img.style.height = "80px";
                        img.style.marginRight = "5px";
                        img.style.borderRadius = "5px";
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        </script>
    </section>
</th:block>
</body>
</html>
