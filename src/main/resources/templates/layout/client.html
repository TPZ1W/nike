<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="vi">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title th:text="${pageTitle ?: 'Trang ch·ªß'} + ' | NiceStore'">Trang ch·ªß | NiceStore</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style-user.css}">
    <script th:src="@{/plugins/jQuery/jQuery-2.2.0.min.js}"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
    <th:block layout:fragment="page_head"></th:block>
</head>
<body>
<div class="nike-top-bar">
    <div class="container-fluid">
        <div class="d-flex justify-content-between">
            <div>
                <a href="#"><i class="fas fa-map-marker-alt me-1"></i> T√¨m c·ª≠a h√†ng</a>
                <a href="#">Tr·ª£ gi√∫p</a>
            </div>
            <div id="auth-section">
                <a href="/register" class="auth-anon">Tham gia</a>
                <a href="/login" class="auth-anon">ƒêƒÉng nh·∫≠p</a>
                <a href="/orders/history" id="user-info" class="auth-user" style="display: none;">
                    Xin ch√†o, <span id="username">User</span>
                </a>
                <a href="#" id="logout-btn" class="auth-user" style="display: none;">ƒêƒÉng xu·∫•t</a>
            </div>
        </div>
    </div>
</div>
<header class="nike-header">
    <nav class="nike-nav container-fluid">
        <a href="/" class="nike-logo">NICESTORE</a>

        <ul class="nike-menu" id="menuList">
            <li><a href="/products">S·∫£n ph·∫©m</a></li>
            <li><a href="/men/shoes">Nam</a></li>
            <li><a href="/women/shoes">N·ªØ</a></li>
            <li><a href="/products?category=kids">Tr·∫ª em</a></li>
            <li><a href="/products?sale=true">Sale</a></li>
        </ul>

        <div class="nike-actions">
            <a href="/carts" class="nike-icon-btn">
                <i class="fas fa-shopping-bag"></i>
                <span class="nike-cart-count" id="headerCartCount">0</span>
            </a>
        </div>
    </nav>
</header>
<div layout:fragment="content"></div>
<footer class="nike-footer">
    <div class="container-fluid">
        <div class="nike-footer-grid">
            <div>
                <h3 class="nike-footer-title">T√¨m c·ª≠a h√†ng</h3>
                <ul class="nike-footer-links">
                    <li><a href="#">Tr·ªü th√†nh th√†nh vi√™n</a></li>
                    <li><a href="#">ƒêƒÉng k√Ω email</a></li>
                    <li><a href="#">Ph·∫£n h·ªìi</a></li>
                    <li><a href="#">M√£ gi·∫£m gi√° sinh vi√™n</a></li>
                </ul>
            </div>
            <div>
                <h3 class="nike-footer-title">Nh·∫≠n tr·ª£ gi√∫p</h3>
                <ul class="nike-footer-links">
                    <li><a href="#">Tr·∫°ng th√°i ƒë∆°n h√†ng</a></li>
                    <li><a href="#">Giao h√†ng</a></li>
                    <li><a href="#">Tr·∫£ h√†ng</a></li>
                    <li><a href="#">Ph∆∞∆°ng th·ª©c thanh to√°n</a></li>
                    <li><a href="#">Li√™n h·ªá</a></li>
                </ul>
            </div>
            <div>
                <h3 class="nike-footer-title">V·ªÅ NiceStore</h3>
                <ul class="nike-footer-links">
                    <li><a href="#">Tin t·ª©c</a></li>
                    <li><a href="#">Ngh·ªÅ nghi·ªáp</a></li>
                    <li><a href="#">Nh√† ƒë·∫ßu t∆∞</a></li>
                    <li><a href="#">Ph√°t tri·ªÉn b·ªÅn v·ªØng</a></li>
                </ul>
            </div>
            <div>
                <h3 class="nike-footer-title">Theo d√µi ch√∫ng t√¥i</h3>
                <div class="nike-social">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
        </div>

        <div class="nike-footer-bottom">
            <div>
                <p class="mb-0">¬© 2025 NiceStore, Inc. B·∫£o l∆∞u m·ªçi quy·ªÅn.</p>
            </div>
            <div>
                <a href="#" style="color: var(--nike-gray); text-decoration: none; margin-right: 20px;">ƒêi·ªÅu kho·∫£n s·ª≠
                    d·ª•ng</a>
                <a href="#" style="color: var(--nike-gray); text-decoration: none;">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // üß© Function to update cart count in header across all pages
    async function updateHeaderCartCount() {
        try {
            const response = await fetch('/api/v1/carts/count');
            if (response.ok) {
                const data = await response.json();
                const headerCartCount = document.getElementById('headerCartCount');
                if (headerCartCount) {
                    headerCartCount.textContent = data.count || 0;
                }
            }
        } catch (error) {
            console.error('Error updating cart count:', error);
        }
    }

    async function fetchInfo() {
        const authAnon = document.querySelectorAll(".auth-anon");
        const authUser = document.querySelectorAll(".auth-user");
        const usernameSpan = document.getElementById("username");
        const logoutBtn = document.getElementById("logout-btn");

        try {
            const res = await fetch("/api/v1/auth/info", {
                credentials: "include", // so cookies are sent
                headers: {"Accept": "application/json"}
            });

            if (res.ok) {
                const data = await res.json();
                if(data.authenticated) {
                    usernameSpan.textContent = data.name;
                    authAnon.forEach(el => el.style.display = "none");
                    authUser.forEach(el => el.style.display = "inline-block");
                } else {
                    authAnon.forEach(el => el.style.display = "inline-block");
                    authUser.forEach(el => el.style.display = "none");
                }
            } else {
                authAnon.forEach(el => el.style.display = "inline-block");
                authUser.forEach(el => el.style.display = "none");
            }
        } catch (err) {
            // Not logged in ‚Üí show login/register
            authAnon.forEach(el => el.style.display = "inline-block");
            authUser.forEach(el => el.style.display = "none");
        }

        // Optional: logout button clears cookie and redirects
        logoutBtn?.addEventListener("click", async (e) => {
            e.preventDefault();
            await fetch("/api/v1/auth/logout", {method: "POST", credentials: "include"});
            location.reload();
        });
    }

    // Update cart count when page loads
    document.addEventListener('DOMContentLoaded', function () {
        updateHeaderCartCount();
        fetchCategories();

        fetchInfo();
    });

    async function fetchCategories() {
        try {
            const response = await fetch('/api/categories');
            if (!response.ok) {
                console.error('‚ùå Failed to fetch categories');
                return;
            }

            const categories = await response.json();
            renderCategories(categories);

        } catch (error) {
            console.error('‚ö†Ô∏è Error fetching categories:', error);
        }
    }

    function renderCategories(categories) {
        const menu = document.getElementById('menuList');
        if (!menu || !Array.isArray(categories)) return;

        menu.innerHTML = `
        <li><a href="/products">S·∫£n ph·∫©m</a></li>
        ${categories.map(cat => `
                    <li><a href="/products?category=${encodeURIComponent(cat.id)}">${cat.name}</a></li>
                `).join('')}
    `;
    }

    // Make the function globally available
    window.updateHeaderCartCount = updateHeaderCartCount;
</script>


</body>
</html>
