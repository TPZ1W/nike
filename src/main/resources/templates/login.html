<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng nh·∫≠p | NiceStore</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Roboto:wght@300;400;500;700&display=swap"
          rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<section class="py-5 bg-secondary">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-5 col-md-7">
                <div class="card border-0 shadow-lg">
                    <div class="card-body p-5">
                        <h2 class="text-center mb-4"
                            style="font-family: var(--heading-font); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                            ƒêƒÇNG NH·∫¨P</h2>

                        <div th:if="${param.error}" class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.
                        </div>
                        <div th:if="${param.logout}" class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>B·∫°n ƒë√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.
                        </div>
                        <div th:if="${param.registered}" class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.
                        </div>

                        <form id="loginForm" class="mb-4">
                            <div class="mb-4">
                                <label for="username" class="form-label fw-semibold">Email</label>
                                <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0">
                                            <i class="fas fa-envelope text-muted"></i>
                                        </span>
                                    <input type="email" class="form-control border-start-0 ps-0" id="username"
                                           name="username" placeholder="nh·∫≠p email c·ªßa b·∫°n" required>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between">
                                    <label for="password" class="form-label fw-semibold">M·∫≠t kh·∫©u</label>
                                    <a th:href="@{/forgot-password}" class="small text-decoration-none">Qu√™n m·∫≠t
                                        kh·∫©u?</a>
                                </div>
                                <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0">
                                            <i class="fas fa-lock text-muted"></i>
                                        </span>
                                    <input type="password" class="form-control border-start-0 ps-0" id="password"
                                           name="password" placeholder="nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n" required>
                                </div>
                            </div>

                            <div class="mb-4 form-check">
                                <input type="checkbox" class="form-check-input" id="rememberMe" name="remember-me">
                                <label class="form-check-label" for="rememberMe">Ghi nh·ªõ ƒëƒÉng nh·∫≠p</label>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-dark py-3 text-uppercase fw-semibold">ƒêƒÉng nh·∫≠p
                                </button>
                            </div>
                        </form>

                        <div class="position-relative text-center mb-4">
                            <hr class="my-4">
                            <span class="position-absolute top-50 start-50 translate-middle px-3 bg-white text-muted small">HO·∫∂C</span>
                        </div>

                        <div class="d-grid gap-2 mb-4">
                            <a href="/oauth2/authorization/google" class="btn btn-outline-dark py-3">
                                <i class="fab fa-google me-2"></i> ƒêƒÉng nh·∫≠p v·ªõi Google
                            </a>
                            <a href="/oauth2/authorization/facebook" class="btn btn-outline-primary py-3">
                                <i class="fab fa-facebook-f me-2"></i> ƒêƒÉng nh·∫≠p v·ªõi Facebook
                            </a>
                        </div>

                        <div class="text-center mt-4">
                            <p class="mb-0">Ch∆∞a c√≥ t√†i kho·∫£n?
                                <a th:href="@{/register}" class="fw-bold text-decoration-none">ƒêƒÉng k√Ω ngay</a>
                            </p>
                            <p class="mb-0"><a th:href="@{/}" class="fw-bold text-decoration-none text-dark">Tr·ªü v·ªÅ trang ch·ªß</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', function (event) {
                event.preventDefault();

                // Remove any existing error messages
                const existingError = loginForm.querySelector('.alert-danger');
                if (existingError) {
                    existingError.remove();
                }

                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('rememberMe').checked;

                // üç™ KH√îNG C·∫¶N X√ìA localStorage n·ªØa - s·ª≠ d·ª•ng cookies

                // Show loading state
                const submitButton = loginForm.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ƒêang x·ª≠ l√Ω...';
                submitButton.disabled = true;

                fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // ‚úÖ QUAN TR·ªåNG: Include cookies
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 401) {
                                throw new Error('T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.');
                            } else {
                                throw new Error('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i sau.');
                            }
                        }
                        return response.json();
                    })
                    .then(data => {
                        // üç™ Backend gi·ªù tr·∫£ v·ªÅ simple response (tokens trong cookies)
                        if (data.success) {
                            // Show success message
                            const successDiv = document.createElement('div');
                            successDiv.className = 'alert alert-success';
                            successDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i>${data.message}! ƒêang chuy·ªÉn h∆∞·ªõng...`;
                            loginForm.insertBefore(successDiv, loginForm.firstChild);

                            // Redirect to home page after a short delay
                            setTimeout(() => {
                                window.location.href = ['ADMIN', 'ROOT'].includes(`${data.role}`.toUpperCase())
                                    ? 'admin/dashboard'
                                    : '/';
                            }, 1000);
                        } else {
                            throw new Error('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);

                        // Show error message
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'alert alert-danger';
                        errorDiv.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>' + error.message;
                        loginForm.insertBefore(errorDiv, loginForm.firstChild);

                        // Reset button state
                        submitButton.innerHTML = originalText;
                        submitButton.disabled = false;
                    });
            });
        } else {
            console.error('Login form not found');
        }
    });
</script>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>