<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/client}">

<th:block layout:fragment="page_head">
    <link rel="stylesheet" href="/css/products.css">
    <link rel="stylesheet" href="/css/product-detail.css">
</th:block>

<body>
<th:block layout:fragment="content">
    <div class="product-detail-container">
        <!-- Success/Error Messages -->
        <div id="success-message" class="success-message">
            <i class="fas fa-check-circle"></i>
            <span id="success-text">ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng th√†nh c√¥ng!</span>
        </div>
        <div id="error-message" class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-text">C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!</span>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="product-image-gallery">
                    <!-- Main Image -->
                    <img id="main-image"
                         th:src="${(product.images != null and !#lists.isEmpty(product.images)) ?
                (#strings.startsWith(product.images[0], 'data:image') ? product.images[0] : '/img/products/' + product.images[0])
                : '/img/products/default-product.jpg'}"
                         th:alt="${product.name}" style="width: 500px; height: 500px; object-fit: cover;"
                         class="img-fluid main-image border rounded shadow-sm">

                    <!-- Thumbnails -->
                    <div class="image-thumbnails d-flex flex-wrap mt-3 gap-2 justify-content-start">
                        <img th:each="img, iStat : ${product.images}"
                             th:src="${#strings.startsWith(img, 'data:image') ? img : '/img/products/' + img}"
                             th:alt="'Thumbnail ' + ${iStat.index + 1}"
                             class="thumbnail-img border rounded"
                             style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;"
                             th:classappend="${iStat.index == 0} ? 'active' : ''"
                             onclick="changeMainImage(this)">
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="product-details">
                    <h1 id="product-name" class="product-name" th:text="${product.name}"></h1>
                    <p id="product-subtitle" class="text-muted" th:text="${product.subTitle}"></p>
                    <p class="text-muted" th:text="'T·ªìn kho:' + ${product.stock}"></p>
                    <div id="product-price" class="product-price"
                         th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">
                    </div>

                    <div class="product-description">
                        <h5>M√¥ t·∫£ s·∫£n ph·∫©m</h5>
                        <p id="product-description" th:text="${product.description}"></p>
                    </div>

                    <!-- Size selection -->
                    <div class="size-selection mt-3">
                        <h5>Ch·ªçn size</h5>
                        <div class="size-options d-flex flex-wrap gap-2" id="size-options">
                            <button type="button"
                                    class="size-btn"
                                    th:each="size : ${sizes}"
                                    th:data-size="${size.name()}"
                                    th:text="${#strings.substring(size.name(), 5)}">
                            </button>
                        </div>
                    </div>

                    <!-- Quantity controls -->
                    <div class="quantity-section mt-3">
                        <h5>S·ªë l∆∞·ª£ng</h5>
                        <div class="quantity-controls d-flex align-items-center gap-2">
                            <button type="button" class="quantity-btn" id="decrease-qty">‚àí</button>
                            <input type="number" id="quantity-input" class="quantity-input" value="1" min="1" max="99">
                            <button type="button" class="quantity-btn" id="increase-qty">+</button>
                        </div>
                    </div>

                    <!-- Add to cart -->
                    <div class="product-actions mt-4">
                        <button id="add-to-cart-btn" class="btn-add-to-cart" disabled>
                            <i class="fas fa-shopping-cart me-2"></i> Th√™m v√†o gi·ªè h√†ng
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
            <!-- Login Prompt (for guests) -->
            <div id="login-prompt" class="text-center p-3" style="background: #f8f9fa; border-bottom: 1px solid #eee;">
                <p class="mb-0">B·∫°n c·∫ßn <a href="/login">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ c√≥ th·ªÉ vi·∫øt ƒë√°nh gi√° v√† b√¨nh lu·∫≠n.</p>
            </div>

            <!-- Reviews List -->
            <!-- Reviews Section -->
            <div class="reviews-section mt-5">
                <div class="reviews-header mb-4">
                    <h3>ƒê√°nh gi√° s·∫£n ph·∫©m</h3>
                </div>

                <div th:if="${#lists.isEmpty(reviews)}" class="no-reviews text-center text-muted p-4">
                    <i class="fas fa-comments fa-2x mb-2"></i>
                    <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho s·∫£n ph·∫©m n√†y.</p>
                    <p>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n!</p>
                </div>

                <div th:each="review : ${reviews}" class="review-item border rounded p-3 mb-3 bg-white shadow-sm">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong th:text="${review.user.fullName}">Ng∆∞·ªùi d√πng</strong>
                            <small class="text-muted ms-2" th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy HH:mm')}"></small>
                        </div>
                        <div class="text-warning">
                <span th:each="i : ${#numbers.sequence(1,5)}"
                      th:text="${i <= review.rating ? '‚òÖ' : '‚òÜ'}"
                      style="font-size: 18px;"></span>
                        </div>
                    </div>

                    <!-- Title -->
                    <div th:if="${review.title != null}" class="fw-bold mb-1" th:text="${review.title}"></div>

                    <!-- Comment -->
                    <p class="mb-2" th:text="${review.comment}">N·ªôi dung b√¨nh lu·∫≠n</p>

                    <!-- Images -->
                    <div th:if="${!#lists.isEmpty(review.images)}" class="review-images d-flex flex-wrap gap-2 mt-2">
                        <img th:each="img : ${review.images}"
                             th:src="${#strings.startsWith(img, 'data:image') ? img : img}"
                             class="border rounded"
                             style="width: 90px; height: 90px; object-fit: cover; border-radius: 8px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        function changeMainImage(thumbnail) {
            const mainImg = document.getElementById("main-image");
            const allThumbs = document.querySelectorAll(".thumbnail-img");

            allThumbs.forEach(img => img.classList.remove("active"));
            thumbnail.classList.add("active");

            mainImg.src = thumbnail.src;
        }

        document.addEventListener("DOMContentLoaded", function () {
            const promtLogin = document.getElementById('login-prompt');
            // Elements
            const sizeButtons = document.querySelectorAll(".size-btn");
            const qtyInput = document.getElementById("quantity-input");
            const decreaseBtn = document.getElementById("decrease-qty");
            const increaseBtn = document.getElementById("increase-qty");
            const addToCartBtn = document.getElementById("add-to-cart-btn");
            setTimeout(() => {
                if(window.isLogin) {
                    promtLogin.style.display = "none";
                 }
            }, 100);
            // State
            let selectedSize = null;

            // üü¢ Select size
            sizeButtons.forEach(btn => {
                btn.addEventListener("click", () => {
                    sizeButtons.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    selectedSize = btn.getAttribute("data-size");
                    updateAddButtonState();
                });
            });


            // üü¢ Quantity control
            decreaseBtn.addEventListener("click", () => {
                let val = parseInt(qtyInput.value);
                if (val > 1) qtyInput.value = val - 1;
            });

            increaseBtn.addEventListener("click", () => {
                let val = parseInt(qtyInput.value);
                if (val < 99) qtyInput.value = val + 1;
            });

            // üü¢ Enable Add to Cart button only when both selected
            function updateAddButtonState() {
                addToCartBtn.disabled = !(selectedSize);
            }

            // üü¢ Add to Cart
            addToCartBtn.addEventListener("click", async () => {
                const qty = parseInt(qtyInput.value);

                const data = {
                    productId: [[${product.id}]], // Thymeleaf injects product ID
                    size: selectedSize,
                    quantity: qty
                };
                try {
                    const response = await fetch("/api/v1/carts/add", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.status === true || result.status === "‚úÖ Th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng") {
                        alert("üõí " + (result.status || "Th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng!"));
                        if (window.updateHeaderCartCount) {
                            window.updateHeaderCartCount();
                        }
                    } else {
                        alert("‚ùå " + (result.message || "Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng."));
                    }
                } catch (error) {
                    console.error("‚ùå L·ªói khi g·ªçi API th√™m gi·ªè h√†ng:", error);
                    alert("ƒê√£ x·∫£y ra l·ªói khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng.");
                }
            });
        });
    </script>
</th:block>
</body>
</html>