<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/client}">

<th:block layout:fragment="page_head">
    <title>Gi·ªè h√†ng c·ªßa b·∫°n</title>
    <link rel="stylesheet" th:href="@{/css/cart.css}">
</th:block>

<body>
<th:block layout:fragment="content">
    <div class="cart-container">
        <div class="cart-header">
            <h2><i class="fa fa-shopping-cart text-primary"></i> Gi·ªè h√†ng c·ªßa b·∫°n</h2>
            <a th:href="@{/products}" class="btn btn-outline-secondary">Ti·∫øp t·ª•c mua s·∫Øm</a>
        </div>

        <!-- N·∫øu gi·ªè h√†ng tr·ªëng -->
        <div th:if="${cart == null or #lists.isEmpty(cart.items)}" class="empty-cart">
            <i class="fa fa-shopping-basket"></i>
            <h4>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h4>
            <a th:href="@{/products}" class="btn btn-primary mt-3">Mua ngay</a>
        </div>

        <!-- N·∫øu c√≥ s·∫£n ph·∫©m -->
        <div th:if="${cart != null and !#lists.isEmpty(cart.items)}">
            <div th:each="item : ${cart.items}" class="cart-item" th:data-id="${item.product.getId()}"
                 th:data-size="${item.size}">
                <img th:src="${item.getProduct()?.getImages() != null ? item.getProduct().getImages().get(0) : '/images/no-image.png'}"
                     alt="S·∫£n ph·∫©m">
                <div class="cart-info">
                    <h5 th:text="${item.getProduct().getName()}"></h5>
                    <p>Gi√°: <span
                            th:text="${#numbers.formatDecimal(item.getProductPrice(), 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                    </p>
                    <p>Size: <span th:text="${item.getSize()}"></span></p>
                </div>

                <div class="cart-actions">
                    <input type="number" class="qty-input" min="1" th:value="${item.getQuantity()}">
                    <button class="btn btn-sm btn-outline-primary btn-update">C·∫≠p nh·∫≠t</button>
                    <button class="btn btn-sm btn-outline-danger btn-remove">X√≥a</button>
                </div>
            </div>

            <!-- Breakdown gi√° ti·ªÅn -->
            <div class="price-breakdown">
                <div class="price-row">
                    <span>T·∫°m t√≠nh (<span id="totalQuantity" th:text="${cart.totalQuantity}"></span> s·∫£n ph·∫©m):</span>
                    <span id="subtotal"
                          th:text="${#numbers.formatDecimal(cart.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                </div>
                <div class="price-row total">
                    <span>T·ªïng c·ªông:</span>
                    <span id="finalTotal"
                          th:text="${#numbers.formatDecimal(cart.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                </div>
            </div>

            <!-- N√∫t thanh to√°n -->
            <div class="cart-summary">
                <a th:href="@{/orders/checkout}" class="btn-checkout">
                    <i class="fa fa-credit-card me-2"></i>Thanh to√°n
                </a>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const cartItems = document.querySelectorAll(".cart-item");

            // üß© H√†m g·ªçi API chung
            const callApi = async (url, method, body = null) => {
                try {
                    const res = await fetch(url, {
                        method: method,
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: body ? JSON.stringify(body) : null
                    });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json().catch(() => ({}));
                } catch (err) {
                    console.error(err);
                    alert("‚ùå L·ªói khi x·ª≠ l√Ω!");
                }
            };

            document.querySelectorAll(".btn-update").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const parent = btn.closest(".cart-item");
                    const productId = parent.dataset.id;
                    const size = parent.dataset.size;
                    const qty = parent.querySelector(".qty-input").value;

                    const result = await callApi("/api/v1/carts/update", "PATCH", {
                        productId: productId,
                        quantity: parseInt(qty),
                        size: size
                    });

                    if (result) {
                        alert("‚úÖ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√†nh c√¥ng!");
                        // Update cart count in header and reload page  
                        if (window.updateHeaderCartCount) {
                            window.updateHeaderCartCount();
                        }
                        window.location.reload();
                    }
                });
            });

            document.querySelectorAll(".btn-remove").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const parent = btn.closest(".cart-item");
                    const productId = parent.dataset.id;
                    const size = parent.dataset.size;
                    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?")) return;
                    const result = await callApi(`/api/v1/carts/remove/${productId}/${size}`, "DELETE");
                    if (result !== undefined) {
                        alert("üóëÔ∏è ƒê√£ x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng!");
                        // Update cart count in header and reload page
                        if (window.updateHeaderCartCount) {
                            window.updateHeaderCartCount();
                        }
                        window.location.reload();
                    }
                });
            });

            // üß© Auto-update quantities when typing
            document.querySelectorAll(".qty-input").forEach(input => {
                input.addEventListener("change", (e) => {
                    const parent = e.target.closest(".cart-item");
                    const updateBtn = parent.querySelector(".btn-update");
                    if (updateBtn) {
                        updateBtn.style.background = "#28a745";
                        updateBtn.textContent = "L∆∞u";
                    }
                });
            });

            // üß© Calculate and update totals in real-time
            const updateCartTotals = () => {
                let subtotal = 0;
                let totalQuantity = 0;

                document.querySelectorAll(".cart-item").forEach(item => {
                    const priceText = item.querySelector(".cart-info p:first-of-type span").textContent;
                    const price = parseFloat(priceText.replace(/[^\d]/g, ''));
                    const qtyInput = item.querySelector(".qty-input");
                    const quantity = qtyInput ? parseInt(qtyInput.value) || 1 : 1;

                    subtotal += price * quantity;
                    totalQuantity += quantity;
                });

                // Update DOM
                const subtotalElement = document.getElementById("subtotal");
                const totalQuantityElement = document.getElementById("totalQuantity");
                const finalTotalElement = document.getElementById("finalTotal");
                const headerCartCount = document.getElementById("headerCartCount");

                if (subtotalElement) {
                    subtotalElement.textContent = formatCurrency(subtotal);
                }

                if (totalQuantityElement) {
                    totalQuantityElement.textContent = totalQuantity;
                }

                if (finalTotalElement) {
                    finalTotalElement.textContent = formatCurrency(subtotal);
                }

                // Update header cart count
                if (headerCartCount) {
                    headerCartCount.textContent = totalQuantity;
                }
            };

            // üß© Utility function
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('vi-VN').format(amount) + " ‚Ç´";
            };

            // üß© Initial calculation on page load
            updateCartTotals();

            // üß© Listen for quantity changes
            document.querySelectorAll(".qty-input").forEach(input => {
                input.addEventListener("input", updateCartTotals);
                input.addEventListener("change", (e) => {
                    const parent = e.target.closest(".cart-item");
                    const updateBtn = parent.querySelector(".btn-update");
                    if (updateBtn) {
                        updateBtn.style.background = "#28a745";
                        updateBtn.textContent = "L∆∞u";
                    }
                    updateCartTotals();
                });
            });
        });
    </script>
</th:block>
</body>
</html>
