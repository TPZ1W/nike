<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/client}">

<th:block layout:fragment="page_head">
    <title>Thanh to√°n - Nike Store</title>
    <link rel="stylesheet" th:href="@{/css/checkout.css}">
    <link rel="stylesheet" th:href="@{/css/coupon-apply.css}">
</th:block>

<body>
<th:block layout:fragment="content">

    <section class="checkout-section container mt-4">
        <h2 class="mb-4 text-center">üõí Thanh to√°n ƒë∆°n h√†ng</h2>

        <!-- Danh s√°ch s·∫£n ph·∫©m trong gi·ªè -->
        <div class="cart-summary mb-4">
            <table class="table table-bordered text-center align-middle">
                <thead class="table-light">
                <tr>
                    <th>S·∫£n ph·∫©m</th>
                    <th>Gi√°</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>T·ªïng</th>
                </tr>
                </thead>
                <tbody id="cart-body">
                <!-- JS s·∫Ω render -->
                </tbody>
            </table>

            <!-- üé´ Ph·∫ßn √°p d·ª•ng m√£ gi·∫£m gi√° -->
            <div class="coupon-section">
                <h5><i class="fa fa-ticket"></i> M√£ gi·∫£m gi√°</h5>
                <div class="best-coupon-banner" id="bestCouponBanner">
                    <i class="fa fa-star"></i>
                    <span>√Åp d·ª•ng m√£ t·ªët nh·∫•t: <strong id="bestCouponCode"></strong> - Ti·∫øt ki·ªám <strong
                            id="bestCouponSaving"></strong></span>
                </div>

                <div class="coupon-input-group">
                    <input type="text" id="couponInput" class="coupon-input"
                           placeholder="Nh·∫≠p m√£ gi·∫£m gi√° (VD: WELCOME10, SAVE50K)">
                    <button id="applyCouponBtn" class="btn-apply-coupon">
                        <span class="btn-text">√Åp d·ª•ng</span>
                        <span class="loading-spinner" style="display: none;"></span>
                    </button>
                </div>

                <div class="coupon-suggestions">
                    <h6>M√£ g·ª£i √Ω cho b·∫°n:</h6>
                    <div class="suggested-coupons" id="suggestedCoupons">
                        <!-- JavaScript s·∫Ω load -->
                    </div>
                </div>

                <div id="couponResult" class="coupon-result"></div>

                <div id="appliedCoupon" class="applied-coupon">
                    <div class="applied-coupon-header">
                        <div>
                            <div class="applied-coupon-code" id="appliedCouponCode"></div>
                            <div class="applied-coupon-discount" id="appliedCouponDiscount"></div>
                        </div>
                        <button id="removeCouponBtn" class="btn-remove-coupon" title="X√≥a m√£ gi·∫£m gi√°">√ó</button>
                    </div>
                </div>
            </div>

            <!-- Breakdown gi√° ti·ªÅn -->
            <div class="price-breakdown">
                <div class="price-row">
                    <span>T·∫°m t√≠nh (<span id="totalQuantityCheckout"></span> s·∫£n ph·∫©m):</span>
                    <span id="subtotalCheckout">0 ‚Ç´</span>
                </div>
                <div class="price-row discount" id="discountRowCheckout" style="display: none;">
                    <span>Gi·∫£m gi√° (<span id="appliedDiscountCodeCheckout"></span>):</span>
                    <span id="discountAmountCheckout">- 0 ‚Ç´</span>
                </div>
                <div class="price-row total">
                    <span>T·ªïng c·ªông:</span>
                    <span id="finalTotalCheckout">0 ‚Ç´</span>
                </div>
            </div>
        </div>

        <!-- Form th√¥ng tin giao h√†ng -->
        <div class="checkout-form border rounded p-4 bg-light">
            <h4>Th√¥ng tin giao h√†ng</h4>
            <form id="checkoutForm">
                <div class="mb-3">
                    <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng</label>
                    <input type="text" name="shippingAddress" class="form-control"
                           placeholder="VD: 123 Nguy·ªÖn VƒÉn C·ª´, Q5, TP.HCM" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">SDT</label>
                    <input type="text" name="sdt" class="form-control" placeholder="01234567" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                    <select name="paymentMethod" class="form-select" required>
                        <option value="" disabled selected>-- Ch·ªçn ph∆∞∆°ng th·ª©c --</option>
                        <option value="CASH_ON_DELIVERY">Thanh to√°n khi nh·∫≠n h√†ng</option>
                        <option value="VNPAY">VNPAY</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary w-100 mt-3">
                    <i class="fa fa-check-circle me-2"></i> ƒê·∫∑t h√†ng
                </button>
            </form>
        </div>
    </section>

    <!-- Script JS x·ª≠ l√Ω -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const cartBody = document.getElementById("cart-body");
            const form = document.getElementById("checkoutForm");

            // üé´ Coupon functionality
            let currentCoupon = null;
            let originalTotal = 0;

            // üß© L·∫•y d·ªØ li·ªáu gi·ªè h√†ng t·ª´ API
            const loadCart = async () => {
                const res = await fetch("/api/v1/carts");
                if (!res.ok) return alert("Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!");
                const cart = await res.json();

                cartBody.innerHTML = "";
                let total = 0;
                let totalQuantity = 0;

                cart.items.forEach(item => {
                    const subtotal = item.productPrice * item.quantity;
                    total += subtotal;
                    totalQuantity += item.quantity;

                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>
                            <span>${item.product.name} - ${item.size}</span>
                        </td>
                        <td>${formatCurrency(item.productPrice)}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(subtotal)}</td>
                    `;
                    cartBody.appendChild(row);
                });

                originalTotal = cart.totalPrice;
                document.getElementById("totalQuantityCheckout").textContent = totalQuantity;
                document.getElementById("subtotalCheckout").textContent = formatCurrency(total);
                document.getElementById("finalTotalCheckout").textContent = formatCurrency(total);

                // Load coupon suggestions after cart is loaded
                if (total > 0) {
                    await loadSuggestedCoupons();
                }
            };

            const loadSuggestedCoupons = async () => {
                try {
                    const response = await fetch(`/api/v1/coupons/available?amount=${originalTotal}`);
                    if (response.ok) {
                        const coupons = await response.json();
                        const container = document.getElementById("suggestedCoupons");
                        container.innerHTML = "";

                        coupons.slice(0, 4).forEach(coupon => {
                            const badge = document.createElement("span");
                            badge.className = "suggested-coupon";
                            badge.textContent = coupon.code;
                            badge.title = coupon.description;
                            badge.onclick = () => applyCoupon(coupon.code);
                            container.appendChild(badge);
                        });
                    }
                } catch (error) {
                    console.error("Error loading suggested coupons:", error);
                }
            };

            const applyCoupon = async (couponCode) => {
                const btn = document.getElementById("applyCouponBtn");
                const result = document.getElementById("couponResult");
                const input = document.getElementById("couponInput");

                // Show loading
                btn.disabled = true;
                btn.querySelector(".btn-text").style.display = "none";
                btn.querySelector(".loading-spinner").style.display = "inline-block";

                try {
                    const response = await fetch("/api/v1/coupons/apply", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({
                            couponCode: couponCode,
                            orderAmount: originalTotal
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log("Coupon API response:", data); // Debug log

                        if (data.isValid && data.discountAmount > 0) {
                            currentCoupon = data;
                            // Add couponCode to data for showAppliedCoupon function
                            data.couponCode = couponCode;
                            showAppliedCoupon(data);
                            updatePricing(data);
                            showResult("‚úÖ √Åp d·ª•ng m√£ gi·∫£m gi√° th√†nh c√¥ng!", "success");
                            input.value = "";
                            hideBestCouponBanner();
                        } else {
                            showResult("‚ùå " + (data.message || "M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá"), "error");
                        }
                    } else {
                        showResult("‚ùå Kh√¥ng th·ªÉ √°p d·ª•ng m√£ gi·∫£m gi√°", "error");
                    }
                } catch (error) {
                    console.error("Error applying coupon:", error);
                    showResult("‚ùå L·ªói khi √°p d·ª•ng m√£ gi·∫£m gi√°", "error");
                } finally {
                    // Hide loading
                    btn.disabled = false;
                    btn.querySelector(".btn-text").style.display = "inline";
                    btn.querySelector(".loading-spinner").style.display = "none";
                }
            };

            // üé´ Hi·ªÉn th·ªã m√£ gi·∫£m gi√° ƒë√£ √°p d·ª•ng
            const showAppliedCoupon = (couponData) => {
                console.log("showAppliedCoupon called with:", couponData); // Debug log
                const appliedDiv = document.getElementById("appliedCoupon");
                const codeSpan = document.getElementById("appliedCouponCode");
                const discountSpan = document.getElementById("appliedCouponDiscount");

                codeSpan.textContent = couponData.couponCode;
                discountSpan.textContent = `Ti·∫øt ki·ªám ${formatCurrency(couponData.discountAmount)}`;
                appliedDiv.style.display = "block";
                console.log("Applied coupon display updated"); // Debug log
            };

            // üé´ C·∫≠p nh·∫≠t gi√° ti·ªÅn
            const updatePricing = (couponData) => {
                console.log("updatePricing called with:", couponData); // Debug log
                const discountRow = document.getElementById("discountRowCheckout");
                const appliedDiscountCode = document.getElementById("appliedDiscountCodeCheckout");
                const discountAmount = document.getElementById("discountAmountCheckout");
                const finalTotal = document.getElementById("finalTotalCheckout");

                appliedDiscountCode.textContent = couponData.couponCode;
                discountAmount.textContent = `- ${formatCurrency(couponData.discountAmount)}`;
                finalTotal.textContent = formatCurrency(couponData.finalAmount);
                discountRow.style.display = "flex";
                console.log("Pricing updated - discount:", couponData.discountAmount, "final:", couponData.finalAmount); // Debug log
            };

            // üé´ X√≥a m√£ gi·∫£m gi√°
            const removeCoupon = () => {
                currentCoupon = null;
                document.getElementById("appliedCoupon").style.display = "none";
                document.getElementById("discountRowCheckout").style.display = "none";
                document.getElementById("finalTotalCheckout").textContent = formatCurrency(originalTotal);
                showResult("üóëÔ∏è ƒê√£ x√≥a m√£ gi·∫£m gi√°", "success");
            };

            // üé´ Utility functions
            const showResult = (message, type) => {
                const result = document.getElementById("couponResult");
                result.textContent = message;
                result.className = `coupon-result ${type}`;
                result.style.display = "block";
                setTimeout(() => {
                    result.style.display = "none";
                }, 3000);
            };

            const hideBestCouponBanner = () => {
                document.getElementById("bestCouponBanner").style.display = "none";
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('vi-VN').format(amount) + " ‚Ç´";
            };

            // üé´ Event listeners
            document.getElementById("applyCouponBtn").addEventListener("click", () => {
                const couponCode = document.getElementById("couponInput").value.trim();
                if (couponCode) {
                    applyCoupon(couponCode);
                } else {
                    showResult("‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°", "error");
                }
            });

            document.getElementById("couponInput").addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    document.getElementById("applyCouponBtn").click();
                }
            });

            document.getElementById("removeCouponBtn").addEventListener("click", removeCoupon);

            // Load cart data
            await loadCart();

            // üßæ G·ª≠i ƒë∆°n h√†ng
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const payload = {
                    paymentMethod: form.paymentMethod.value,
                    shippingAddress: form.shippingAddress.value,
                    phone: form.sdt.value,
                    couponCode: currentCoupon?.couponCode,
                };

                const res = await fetch("/api/v1/orders/checkout", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.status) {
                        if ('VNPAY' === form.paymentMethod.value) {
                            window.location.href = data.paymentUrl;
                        } else {
                            alert("‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!");
                            window.location.href = '/orders/checkout/success';
                        }
                    } else {
                        alert(`${data.message}`);
                        window.location.href = '/login?redirect=/orders/checkout/success';
                    }
                } else {
                    alert("‚ùå ƒê·∫∑t h√†ng th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i!");
                }
            });
        });
    </script>

</th:block>
</body>
</html>
